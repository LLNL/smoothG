<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.5"/>
<title>smoothG: /home/barker29/graph-laplacian/housekeeping/examples/generalgraph.cpp</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="smoothg_logo_small.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">smoothG
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/home/barker29/graph-laplacian/housekeeping/examples/generalgraph.cpp</div>  </div>
</div><!--header-->
<div class="contents">
<div class="fragment"><div class="line"><span class="comment">/*BHEADER**********************************************************************</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * Copyright (c) 2018, Lawrence Livermore National Security, LLC.</span></div>
<div class="line"><span class="comment"> * Produced at the Lawrence Livermore National Laboratory.</span></div>
<div class="line"><span class="comment"> * LLNL-CODE-745247. All Rights reserved. See file COPYRIGHT for details.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * This file is part of smoothG. For more information and source code</span></div>
<div class="line"><span class="comment"> * availability, see https://www.github.com/llnl/smoothG.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> * smoothG is free software; you can redistribute it and/or modify it under the</span></div>
<div class="line"><span class="comment"> * terms of the GNU Lesser General Public License (as published by the Free</span></div>
<div class="line"><span class="comment"> * Software Foundation) version 2.1 dated February 1999.</span></div>
<div class="line"><span class="comment"> *</span></div>
<div class="line"><span class="comment"> ***********************************************************************EHEADER*/</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;sstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;mpi.h&gt;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;mfem.hpp&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="preprocessor">#include &quot;../src/picojson.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;../src/smoothG.hpp&quot;</span></div>
<div class="line"></div>
<div class="line"><span class="keyword">using</span> std::unique_ptr;</div>
<div class="line"><span class="keyword">using</span> std::shared_ptr;</div>
<div class="line"><span class="keyword">using</span> std::make_shared;</div>
<div class="line"></div>
<div class="line"><span class="keyword">using namespace </span>smoothg;</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> MetisPart(<span class="keyword">const</span> mfem::SparseMatrix&amp; vertex_edge, mfem::Array&lt;int&gt;&amp; part, <span class="keywordtype">int</span> num_parts,</div>
<div class="line">               <span class="keywordtype">int</span> isolate);</div>
<div class="line">mfem::Vector ComputeFiedlerVector(<span class="keyword">const</span> <a name="_a0"></a><a class="code" href="classsmoothg_1_1MixedMatrix.html">MixedMatrix</a>&amp; mixed_laplacian);</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">int</span> <a name="a1"></a><a class="code" href="generalgraph_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>* argv[])</div>
<div class="line">{</div>
<div class="line">    <span class="comment">// 1. Initialize MPI</span></div>
<div class="line">    <span class="keywordtype">int</span> num_procs, myid;</div>
<div class="line">    MPI_Init(&amp;argc, &amp;argv);</div>
<div class="line">    MPI_Comm comm = MPI_COMM_WORLD;</div>
<div class="line">    MPI_Comm_size(comm, &amp;num_procs);</div>
<div class="line">    MPI_Comm_rank(comm, &amp;myid);</div>
<div class="line"></div>
<div class="line">    <span class="comment">// program options from command line</span></div>
<div class="line">    mfem::OptionsParser args(argc, argv);</div>
<div class="line">    <span class="keywordtype">int</span> num_partitions = 12;</div>
<div class="line">    args.AddOption(&amp;num_partitions, <span class="stringliteral">&quot;-np&quot;</span>, <span class="stringliteral">&quot;--num-part&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;Number of partitions to generate with Metis.&quot;</span>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* graphFileName = <span class="stringliteral">&quot;../../graphdata/vertex_edge_sample.txt&quot;</span>;</div>
<div class="line">    args.AddOption(&amp;graphFileName, <span class="stringliteral">&quot;-g&quot;</span>, <span class="stringliteral">&quot;--graph&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;File to load for graph connection data.&quot;</span>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* FiedlerFileName = <span class="stringliteral">&quot;../../graphdata/fiedler_sample.txt&quot;</span>;</div>
<div class="line">    args.AddOption(&amp;FiedlerFileName, <span class="stringliteral">&quot;-f&quot;</span>, <span class="stringliteral">&quot;--fiedler&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;File to load for the Fiedler vector.&quot;</span>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* partition_filename = <span class="stringliteral">&quot;../../graphdata/partition_sample.txt&quot;</span>;</div>
<div class="line">    args.AddOption(&amp;partition_filename, <span class="stringliteral">&quot;-p&quot;</span>, <span class="stringliteral">&quot;--partition&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;Partition file to load (instead of using metis).&quot;</span>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* weight_filename = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line">    args.AddOption(&amp;weight_filename, <span class="stringliteral">&quot;-w&quot;</span>, <span class="stringliteral">&quot;--weight&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;File to load for graph edge weights.&quot;</span>);</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">char</span>* w_block_filename = <span class="stringliteral">&quot;&quot;</span>;</div>
<div class="line">    args.AddOption(&amp;w_block_filename, <span class="stringliteral">&quot;-wb&quot;</span>, <span class="stringliteral">&quot;--w_block&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;File to load for w block.&quot;</span>);</div>
<div class="line">    <span class="keywordtype">bool</span> metis_agglomeration = <span class="keyword">false</span>;</div>
<div class="line">    args.AddOption(&amp;metis_agglomeration, <span class="stringliteral">&quot;-ma&quot;</span>, <span class="stringliteral">&quot;--metis-agglomeration&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;-nm&quot;</span>, <span class="stringliteral">&quot;--no-metis-agglomeration&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;Use Metis as the partitioner (instead of loading partition).&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> max_evects = 4;</div>
<div class="line">    args.AddOption(&amp;max_evects, <span class="stringliteral">&quot;-m&quot;</span>, <span class="stringliteral">&quot;--max-evects&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;Maximum eigenvectors per aggregate.&quot;</span>);</div>
<div class="line">    <span class="keywordtype">double</span> spect_tol = 1.e-3;</div>
<div class="line">    args.AddOption(&amp;spect_tol, <span class="stringliteral">&quot;-t&quot;</span>, <span class="stringliteral">&quot;--spect-tol&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;Spectral tolerance for eigenvalue problems.&quot;</span>);</div>
<div class="line">    <span class="keywordtype">bool</span> hybridization = <span class="keyword">false</span>;</div>
<div class="line">    args.AddOption(&amp;hybridization, <span class="stringliteral">&quot;-hb&quot;</span>, <span class="stringliteral">&quot;--hybridization&quot;</span>, <span class="stringliteral">&quot;-no-hb&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;--no-hybridization&quot;</span>, <span class="stringliteral">&quot;Enable hybridization.&quot;</span>);</div>
<div class="line">    <span class="keywordtype">bool</span> generate_graph = <span class="keyword">false</span>;</div>
<div class="line">    args.AddOption(&amp;generate_graph, <span class="stringliteral">&quot;-gg&quot;</span>, <span class="stringliteral">&quot;--generate-graph&quot;</span>, <span class="stringliteral">&quot;-no-gg&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;--no-generate-graph&quot;</span>, <span class="stringliteral">&quot;Generate a graph at runtime.&quot;</span>);</div>
<div class="line">    <span class="keywordtype">bool</span> generate_fiedler = <span class="keyword">false</span>;</div>
<div class="line">    args.AddOption(&amp;generate_fiedler, <span class="stringliteral">&quot;-gf&quot;</span>, <span class="stringliteral">&quot;--generate-fiedler&quot;</span>, <span class="stringliteral">&quot;-no-gf&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;--no-generate-fiedler&quot;</span>, <span class="stringliteral">&quot;Generate a fiedler vector at runtime.&quot;</span>);</div>
<div class="line">    <span class="keywordtype">bool</span> save_fiedler = <span class="keyword">false</span>;</div>
<div class="line">    args.AddOption(&amp;save_fiedler, <span class="stringliteral">&quot;-sf&quot;</span>, <span class="stringliteral">&quot;--save-fiedler&quot;</span>, <span class="stringliteral">&quot;-no-sf&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;--no-save-fiedler&quot;</span>, <span class="stringliteral">&quot;Save a generate a fiedler vector at runtime.&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> gen_vertices = 1000;</div>
<div class="line">    args.AddOption(&amp;gen_vertices, <span class="stringliteral">&quot;-nv&quot;</span>, <span class="stringliteral">&quot;--num-vert&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;Number of vertices of the graph to be generated.&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> mean_degree = 40;</div>
<div class="line">    args.AddOption(&amp;mean_degree, <span class="stringliteral">&quot;-md&quot;</span>, <span class="stringliteral">&quot;--mean-degree&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;Average vertex degree of the graph to be generated.&quot;</span>);</div>
<div class="line">    <span class="keywordtype">double</span> beta = 0.15;</div>
<div class="line">    args.AddOption(&amp;beta, <span class="stringliteral">&quot;-b&quot;</span>, <span class="stringliteral">&quot;--beta&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;Probability of rewiring in the Watts-Strogatz model.&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> seed = 0;</div>
<div class="line">    args.AddOption(&amp;seed, <span class="stringliteral">&quot;-s&quot;</span>, <span class="stringliteral">&quot;--seed&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;Seed (unsigned integer) for the random number generator.&quot;</span>);</div>
<div class="line">    <span class="keywordtype">int</span> isolate = -1;</div>
<div class="line">    args.AddOption(&amp;isolate, <span class="stringliteral">&quot;--isolate&quot;</span>, <span class="stringliteral">&quot;--isolate&quot;</span>,</div>
<div class="line">                   <span class="stringliteral">&quot;Isolate a single vertex (for debugging so far).&quot;</span>);</div>
<div class="line">    args.Parse();</div>
<div class="line">    <span class="keywordflow">if</span> (!args.Good())</div>
<div class="line">    {</div>
<div class="line">        <span class="keywordflow">if</span> (myid == 0)</div>
<div class="line">        {</div>
<div class="line">            args.PrintUsage(std::cout);</div>
<div class="line">        }</div>
<div class="line">        MPI_Finalize();</div>
<div class="line">        <span class="keywordflow">return</span> 1;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">if</span> (myid == 0)</div>
<div class="line">    {</div>
<div class="line">        args.PrintOptions(std::cout);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    assert(num_partitions &gt;= num_procs);</div>
<div class="line"></div>
<div class="line">    mfem::SparseMatrix vertex_edge_global;</div>
<div class="line">    <span class="keywordflow">if</span> (generate_graph)</div>
<div class="line">    {</div>
<div class="line">        mfem::SparseMatrix tmp = <a name="a2"></a><a class="code" href="namespacesmoothg.html#a573089cfdbcc5cab22e56dac68581703">GenerateGraph</a>(comm, gen_vertices, mean_degree, beta, seed);</div>
<div class="line">        vertex_edge_global.Swap(tmp);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        mfem::SparseMatrix tmp = <a name="a3"></a><a class="code" href="namespacesmoothg.html#a62c0196b945970d7f1d40dd91d8208ea">ReadVertexEdge</a>(graphFileName);</div>
<div class="line">        vertex_edge_global.Swap(tmp);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> nedges_global = vertex_edge_global.Width();</div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">int</span> nvertices_global = vertex_edge_global.Height();</div>
<div class="line"></div>
<div class="line"></div>
<div class="line">    mfem::Array&lt;int&gt; global_partitioning;</div>
<div class="line">    <span class="keywordflow">if</span> (metis_agglomeration || generate_graph)</div>
<div class="line">    {</div>
<div class="line">        MetisPart(vertex_edge_global, global_partitioning, num_partitions, isolate);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        std::ifstream partFile(partition_filename);</div>
<div class="line">        global_partitioning.SetSize(nvertices_global);</div>
<div class="line">        global_partitioning.Load(partFile, nvertices_global);</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    mfem::Vector weight(nedges_global);</div>
<div class="line">    <span class="keywordflow">if</span> (std::strlen(weight_filename))</div>
<div class="line">    {</div>
<div class="line">        std::ifstream weight_file(weight_filename);</div>
<div class="line">        weight.Load(weight_file, nedges_global);</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        weight = 1.0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Set up GraphUpscale</span></div>
<div class="line">    {</div>
<div class="line">        <a name="_a4"></a><a class="code" href="classsmoothg_1_1GraphUpscale.html">GraphUpscale</a> upscale(comm, vertex_edge_global, global_partitioning,</div>
<div class="line">                             spect_tol, max_evects, hybridization, weight);</div>
<div class="line"></div>
<div class="line">        upscale.PrintInfo();</div>
<div class="line">        upscale.ShowSetupTime();</div>
<div class="line"></div>
<div class="line">        mfem::Vector rhs_u_fine;</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (generate_graph || generate_fiedler)</div>
<div class="line">        {</div>
<div class="line">            rhs_u_fine = ComputeFiedlerVector(upscale.GetFineMatrix());</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            rhs_u_fine = upscale.ReadVertexVector(FiedlerFileName);</div>
<div class="line">        }</div>
<div class="line"></div>
<div class="line">        mfem::BlockVector fine_rhs(upscale.GetFineBlockVector());</div>
<div class="line">        fine_rhs.GetBlock(0) = 0.0;</div>
<div class="line">        fine_rhs.GetBlock(1) = rhs_u_fine;</div>
<div class="line"></div>
<div class="line">        mfem::BlockVector upscaled_sol = upscale.Solve(fine_rhs);</div>
<div class="line">        upscale.ShowCoarseSolveInfo();</div>
<div class="line"></div>
<div class="line">        mfem::BlockVector fine_sol = upscale.SolveFine(fine_rhs);</div>
<div class="line">        upscale.ShowFineSolveInfo();</div>
<div class="line"></div>
<div class="line">        upscale.ShowErrors(upscaled_sol, fine_sol);</div>
<div class="line"></div>
<div class="line">        <span class="keywordflow">if</span> (save_fiedler)</div>
<div class="line">        {</div>
<div class="line">            upscale.WriteVertexVector(rhs_u_fine, FiedlerFileName);</div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    MPI_Finalize();</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line"><span class="keywordtype">void</span> MetisPart(<span class="keyword">const</span> mfem::SparseMatrix&amp; vertex_edge, mfem::Array&lt;int&gt;&amp; part, <span class="keywordtype">int</span> num_parts,</div>
<div class="line">               <span class="keywordtype">int</span> isolate)</div>
<div class="line">{</div>
<div class="line">    <a name="_a5"></a><a class="code" href="classsmoothg_1_1MetisGraphPartitioner.html">smoothg::MetisGraphPartitioner</a> partitioner;</div>
<div class="line">    partitioner.<a name="a6"></a><a class="code" href="classsmoothg_1_1MetisGraphPartitioner.html#a13be7d670c36c9869044b05584c27040">setUnbalanceTol</a>(2);</div>
<div class="line">    mfem::SparseMatrix edge_vertex = <a name="a7"></a><a class="code" href="namespacesmoothg.html#a4b0eacbfc58943662b27572af61d4391">smoothg::Transpose</a>(vertex_edge);</div>
<div class="line">    mfem::SparseMatrix vertex_vertex = <a name="a8"></a><a class="code" href="namespacesmoothg.html#a73f21a9a7d1292763ed8d1343ba02ddc">smoothg::Mult</a>(vertex_edge, edge_vertex);</div>
<div class="line"></div>
<div class="line">    mfem::Array&lt;int&gt; post_isolate_vertices;</div>
<div class="line">    <span class="keywordflow">if</span> (isolate &gt;= 0)</div>
<div class="line">        post_isolate_vertices.Append(isolate);</div>
<div class="line"></div>
<div class="line">    partitioner.<a name="a9"></a>SetPostIsolateVertices(post_isolate_vertices);</div>
<div class="line"></div>
<div class="line">    partitioner.<a name="a10"></a><a class="code" href="classsmoothg_1_1MetisGraphPartitioner.html#ae268ade5ed5447303f2fa36bea098039">doPartition</a>(vertex_vertex, num_parts, part);</div>
<div class="line">}</div>
<div class="line"></div>
<div class="line">mfem::Vector ComputeFiedlerVector(<span class="keyword">const</span> <a class="code" href="classsmoothg_1_1MixedMatrix.html">MixedMatrix</a>&amp; mixed_laplacian)</div>
<div class="line">{</div>
<div class="line">    <span class="keyword">auto</span>&amp; pM = mixed_laplacian.<a name="a11"></a><a class="code" href="classsmoothg_1_1MixedMatrix.html#a50c843d56f6b841fe9085cb4f1898960">get_pM</a>();</div>
<div class="line">    <span class="keyword">auto</span>&amp; pD = mixed_laplacian.<a name="a12"></a><a class="code" href="classsmoothg_1_1MixedMatrix.html#a43f42003876f5c5dafb8beb73e90173a">get_pD</a>();</div>
<div class="line">    <span class="keyword">auto</span>* pW = mixed_laplacian.<a name="a13"></a><a class="code" href="classsmoothg_1_1MixedMatrix.html#a7d4ce0172e3acd0c80034e453fb02db5">get_pW</a>();</div>
<div class="line"></div>
<div class="line">    unique_ptr&lt;mfem::HypreParMatrix&gt; MinvDT(pD.Transpose());</div>
<div class="line"></div>
<div class="line">    mfem::HypreParVector M_inv(pM.GetComm(), pM.GetGlobalNumRows(), pM.GetRowStarts());</div>
<div class="line">    pM.GetDiag(M_inv);</div>
<div class="line">    MinvDT-&gt;InvScaleRows(M_inv);</div>
<div class="line"></div>
<div class="line">    unique_ptr&lt;mfem::HypreParMatrix&gt; A(mfem::ParMult(&amp;pD, MinvDT.get()));</div>
<div class="line"></div>
<div class="line">    <span class="keyword">const</span> <span class="keywordtype">bool</span> use_w = mixed_laplacian.<a name="a14"></a><a class="code" href="classsmoothg_1_1MixedMatrix.html#a37a76ced49e1e3fd63d73c71455b5f88">CheckW</a>();</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (use_w)</div>
<div class="line">    {</div>
<div class="line">        (*pW) *= -1.0;</div>
<div class="line">        <span class="comment">// TODO(gelever1): define ParSub lol</span></div>
<div class="line">        A.reset(<a name="a15"></a><a class="code" href="namespacesmoothg.html#a122311dc2c2578bd483a89334938cfad">ParAdd</a>(*A, *pW));</div>
<div class="line">        (*pW) *= -1.0;</div>
<div class="line">    }</div>
<div class="line">    <span class="keywordflow">else</span></div>
<div class="line">    {</div>
<div class="line">        <span class="comment">// Adding identity to A so that it is non-singular</span></div>
<div class="line">        mfem::SparseMatrix diag;</div>
<div class="line">        A-&gt;GetDiag(diag);</div>
<div class="line">        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> i = 0; i &lt; diag.Width(); i++)</div>
<div class="line">            diag(i, i) += 1.0;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    mfem::HypreBoomerAMG prec(*A);</div>
<div class="line">    prec.SetPrintLevel(0);</div>
<div class="line"></div>
<div class="line">    mfem::HypreLOBPCG lobpcg(A-&gt;GetComm());</div>
<div class="line">    lobpcg.SetMaxIter(5000);</div>
<div class="line">    lobpcg.SetTol(1e-8);</div>
<div class="line">    lobpcg.SetPrintLevel(0);</div>
<div class="line">    lobpcg.SetNumModes(2);</div>
<div class="line">    lobpcg.SetOperator(*A);</div>
<div class="line">    lobpcg.SetPreconditioner(prec);</div>
<div class="line">    lobpcg.Solve();</div>
<div class="line"></div>
<div class="line">    mfem::Array&lt;double&gt; evals;</div>
<div class="line">    lobpcg.GetEigenvalues(evals);</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">bool</span> converged = <span class="keyword">true</span>;</div>
<div class="line"></div>
<div class="line">    <span class="comment">// First eigenvalue of A+I should be 1 (graph Laplacian has a 1D null space)</span></div>
<div class="line">    <span class="keywordflow">if</span> (!use_w)</div>
<div class="line">    {</div>
<div class="line">        converged &amp;= std::abs(evals[0] - 1.0) &lt; 1e-8;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="comment">// Second eigenvalue of A+I should be greater than 1 for connected graphs</span></div>
<div class="line">    converged &amp;= std::abs(evals[1] - 1.0) &gt; 1e-8;</div>
<div class="line"></div>
<div class="line">    <span class="keywordtype">int</span> myid;</div>
<div class="line">    MPI_Comm_rank(MPI_COMM_WORLD, &amp;myid);</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">if</span> (!converged &amp;&amp; myid == 0)</div>
<div class="line">    {</div>
<div class="line">        std::cout &lt;&lt; <span class="stringliteral">&quot;LOBPCG Failed to converge: \n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; evals[0] &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">        std::cout &lt;&lt; evals[1] &lt;&lt; <span class="stringliteral">&quot;\n&quot;</span>;</div>
<div class="line">    }</div>
<div class="line"></div>
<div class="line">    <span class="keywordflow">return</span> lobpcg.GetEigenvector(1);</div>
<div class="line">}</div>
</div><!-- fragment --> </div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.5
</small></address>
</body>
</html>
