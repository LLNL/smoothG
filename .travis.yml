sudo: false

language: cpp

matrix:
  include:
    - os: linux
      compiler: gcc
      addons:
        apt:
          packages:
            - liblapack-dev
            - libblas-dev
            - valgrind
      cache:
        directories:
          - $TRAVIS_BUILD_DIR/extern/metis
          - $TRAVIS_BUILD_DIR/extern/SuiteSparse
          - $TRAVIS_BUILD_DIR/extern/mpich
          - $TRAVIS_BUILD_DIR/extern/hypre

install:
    - if [ ! -e extern/metis/lib/libmetis.a ]; then
        sh config/build_scripts/build_metis.sh;
     else
        echo "Reusing cached metis";
     fi;

    - if [ ! -e extern/SuiteSparse/lib/libumfpack.so ]; then
        sh config/build_scripts/build_suitesparse.sh;
     else
        echo "Reusing cached SuiteSparse-4.5.4";
     fi;

    - if [ ! -e extern/mpich/bin/mpirun ]; then
        sh config/build_scripts/build_mpich.sh;
        export PATH=$TRAVIS_BUILD_DIR/extern/mpich/bin:$PATH;
     else
        export PATH=$TRAVIS_BUILD_DIR/extern/mpich/bin:$PATH;
        echo "Reusing cached mpich";
     fi;

    - if [ ! -e extern/hypre/lib/libHYPRE.a ]; then
        sh config/build_scripts/build_hypre.sh;
     else
        echo "Reusing cached hypre-2.10.0b";
     fi;

    - sh config/build_scripts/build_linalg.sh;

script:
   - cd $TRAVIS_BUILD_DIR;

   # Build the library
   - sh config/extern_build.sh;

   # Run tests
   - cd build;
   - CTEST_OUTPUT_ON_FAILURE=1 make test;
